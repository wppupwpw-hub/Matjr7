<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع إعلانات لكسب الدنانير</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .ad-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out;
        }
        .ad-card:hover {
            transform: translateY(-5px);
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        /* Style for modals to ensure they are centered and visible */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="bg-white shadow-md p-4">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">موقع الإعلانات</h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="flex items-center space-x-2 space-x-reverse">
                    <span id="userBalance" class="text-xl font-semibold text-green-600">0.00 دينار</span>
                </div>
                <button id="menuBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full font-semibold hover:bg-gray-300 transition duration-300">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Side Menu -->
    <div id="sidebar" class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl z-50 p-6 flex flex-col justify-start items-center space-y-4">
        <button id="closeBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <div class="w-full text-center py-4 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800">حسابي</h3>
            <p id="authStatus" class="text-sm text-gray-500 mt-1">يتم التحقق من حالة المصادقة...</p>
        </div>
        <button id="emailSignInBtn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition duration-300 hidden">
            <i class="fas fa-envelope ml-2"></i> تسجيل الدخول بالبريد
        </button>
        <button id="emailSignUpBtn" class="w-full bg-green-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-green-700 transition duration-300 hidden">
            <i class="fas fa-user-plus ml-2"></i> إنشاء حساب بالبريد
        </button>
        <!-- Google Sign-in Button -->
        <button id="googleSignInBtn" class="w-full bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition duration-300 flex items-center justify-center space-x-2 space-x-reverse hidden">
            <i class="fab fa-google ml-2"></i> تسجيل الدخول عبر غوغل
        </button>
        <button id="walletBtn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition duration-300 hidden">
            <i class="fas fa-wallet ml-2"></i> محفظتي
        </button>
        <button id="signOutBtn" class="w-full bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition duration-300 hidden">
            <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
        </button>
    </div>

    <main class="container mx-auto my-8 p-4 flex-grow">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <h2 class="text-2xl font-bold text-gray-700 mb-2">رصيدك الحالي</h2>
            <p class="text-4xl font-extrabold text-blue-600"><span id="balanceDisplay">0.00</span> دينار</p>
            <p id="userIdDisplay" class="text-sm text-gray-500 mt-2 text-right">معرف المستخدم: <span id="userIdValue">...</span></p>
        </div>

        <h2 class="text-2xl font-bold text-gray-700 mb-4">شاهد الإعلانات واكسب</h2>
        <div id="adsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Ad cards will be inserted here by JavaScript -->
        </div>
    </main>

    <!-- Modal for messages -->
    <div id="modal" class="modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center">
            <p id="modalMessage" class="text-lg font-semibold mb-4"></p>
            <button id="modalCloseButton" class="bg-blue-600 text-white px-4 py-2 rounded-lg">إغلاق</button>
        </div>
    </div>

    <!-- Modal for Email/Password forms -->
    <div id="authModal" class="modal-container">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-80">
            <h3 id="authModalTitle" class="text-2xl font-bold mb-4"></h3>
            <input type="email" id="authEmail" placeholder="البريد الإلكتروني" class="w-full p-3 mb-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input type="password" id="authPassword" placeholder="كلمة المرور" class="w-full p-3 mb-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="authSubmitBtn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition duration-300">
                تأكيد
            </button>
            <button id="authModalCloseBtn" class="w-full mt-4 text-gray-600 hover:text-gray-800">
                إلغاء
            </button>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * ملاحظة مهمة جداً حول الأخطاء:
         * الخطأ "Missing or insufficient permissions" الذي يظهر في وحدة التحكم (Console) ليس خطأ في الشيفرة البرمجية.
         * إنه يعني أن قواعد الأمان (Firebase Security Rules) الخاصة بقاعدة بيانات Firestore لا تسمح بالوصول إلى البيانات.
         *
         * لتصحيح هذا الخطأ:
         * 1. اذهب إلى لوحة تحكم مشروعك في Firebase.
         * 2. اختر "Firestore Database" من القائمة الجانبية.
         * 3. انتقل إلى علامة التبويب "Rules" (القواعد).
         * 4. قم بلصق القواعد التالية في المحرر، ثم اضغط على "Publish" (نشر).
         *
         * ```
         * rules_version = '2';
         * service cloud.firestore {
         * match /databases/{database}/documents {
         * // هذه القاعدة تسمح للمستخدم المصادق عليه (بما في ذلك المستخدم المجهول)
         * // بقراءة وكتابة البيانات في مساره الخاص فقط.
         * match /artifacts/{appId}/users/{userId}/{document=**} {
         * allow read, write: if request.auth != null && request.auth.uid == userId;
         * }
         * }
         * }
         * ```
         * بعد تطبيق هذه القواعد، سيعمل التطبيق بشكل صحيح بعد تسجيل الدخول.
         */
        
        // Enable debug logging for Firebase Firestore
        setLogLevel('debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const googleClientId = '640635892482-ldefv7a2slqgrq09of42qpme20eumkq9.apps.googleusercontent.com';

        let app;
        let auth;
        let db;
        let userId;
        let isAuthReady = false;

        // Get UI elements
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const closeBtn = document.getElementById('closeBtn');
        const emailSignInBtn = document.getElementById('emailSignInBtn');
        const emailSignUpBtn = document.getElementById('emailSignUpBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const walletBtn = document.getElementById('walletBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const authStatus = document.getElementById('authStatus');

        const balanceDisplay = document.getElementById('balanceDisplay');
        const userBalanceSpan = document.getElementById('userBalance');
        const userIdDisplay = document.getElementById('userIdValue');
        const adsContainer = document.getElementById('adsContainer');

        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');

        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authModalCloseBtn = document.getElementById('authModalCloseBtn');

        // Dummy ads data
        const ads = [
            { id: 1, title: 'إعلان لسيارة فاخرة', imageUrl: 'https://placehold.co/400x250/333333/ffffff?text=Car+Ad', reward: 0.50, description: 'شاهد إعلانًا لسيارة جديدة واكسب 0.50 دينار.' },
            { id: 2, title: 'تطبيق جديد', imageUrl: 'https://placehold.co/400x250/1d4ed8/ffffff?text=App+Ad', reward: 0.25, description: 'اكسب 0.25 دينار بمشاهدة إعلان عن تطبيق جديد.' },
            { id: 3, title: 'أحذية رياضية', imageUrl: 'https://placehold.co/400x250/22c55e/ffffff?text=Shoes+Ad', reward: 0.75, description: 'شاهد إعلانًا عن أحدث الأحذية الرياضية واكسب 0.75 دينار.' },
            { id: 4, title: 'مأكولات ومشروبات', imageUrl: 'https://placehold.co/400x250/f97316/ffffff?text=Food+%26+Drinks', reward: 0.40, description: 'احصل على 0.40 دينار لمشاهدة هذا الإعلان.' },
        ];

        // --- Helper Functions ---
        
        // Displays a custom modal message
        function showMessage(message) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
        }

        modalCloseButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Shows the email/password authentication modal
        function showAuthModal(type) {
            authEmail.value = '';
            authPassword.value = '';
            if (type === 'signIn') {
                authModalTitle.textContent = 'تسجيل الدخول';
                authSubmitBtn.textContent = 'تسجيل الدخول';
                authSubmitBtn.onclick = () => handleEmailAuth(signInWithEmailAndPassword);
            } else {
                authModalTitle.textContent = 'إنشاء حساب';
                authSubmitBtn.textContent = 'إنشاء حساب';
                authSubmitBtn.onclick = () => handleEmailAuth(createUserWithEmailAndPassword);
            }
            authModal.style.display = 'flex';
        }

        authModalCloseBtn.addEventListener('click', () => {
            authModal.style.display = 'none';
        });

        // Handles email/password authentication (sign in or sign up)
        async function handleEmailAuth(authFunction) {
            const email = authEmail.value;
            const password = authPassword.value;
            if (!email || !password) {
                showMessage('الرجاء إدخال البريد الإلكتروني وكلمة المرور.');
                return;
            }
            try {
                await authFunction(auth, email, password);
                authModal.style.display = 'none';
                showMessage('تمت المصادقة بنجاح.');
            } catch (error) {
                console.error("Authentication Error:", error);
                let message = 'حدث خطأ في المصادقة.';
                if (error.code === 'auth/email-already-in-use') {
                    message = 'هذا البريد الإلكتروني مستخدم بالفعل.';
                } else if (error.code === 'auth/invalid-credential') {
                    message = 'البيانات غير صحيحة. يرجى التحقق من البريد وكلمة المرور.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'كلمة المرور ضعيفة جدًا.';
                }
                showMessage(message);
            }
        }

        // --- Firebase Functions ---

        // Initializes Firebase and sets up authentication
        async function initializeFirebase() {
            try {
                // Initialize the app with the provided config
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        // Determine display name based on auth provider
                        let displayName = 'مستخدم مجهول';
                        if (user.providerData && user.providerData.length > 0) {
                            const providerId = user.providerData[0].providerId;
                            if (providerId === 'google.com') {
                                displayName = user.displayName || 'مستخدم غوغل';
                            } else if (user.email) {
                                displayName = user.email;
                            }
                        }
                        
                        authStatus.textContent = `مرحباً، ${displayName}!`;
                        userIdDisplay.textContent = userId;
                        signOutBtn.classList.remove('hidden');
                        walletBtn.classList.remove('hidden');
                        emailSignInBtn.classList.add('hidden');
                        emailSignUpBtn.classList.add('hidden');
                        googleSignInBtn.classList.add('hidden');
                        setupRealtimeListener();
                    } else {
                        userId = null;
                        authStatus.textContent = 'غير متصل';
                        userIdDisplay.textContent = '...';
                        balanceDisplay.textContent = '0.00';
                        userBalanceSpan.textContent = '0.00 دينار';
                        signOutBtn.classList.add('hidden');
                        walletBtn.classList.add('hidden');
                        emailSignInBtn.classList.remove('hidden');
                        emailSignUpBtn.classList.remove('hidden');
                        googleSignInBtn.classList.remove('hidden');
                    }
                });

                // Do not automatically sign in. Let the user choose.
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Even with an error, the app should continue to display,
                // but with limited functionality.
            }
        }

        // Sets up a real-time listener for the user's balance
        function setupRealtimeListener() {
            if (!userId || !db || !isAuthReady) {
                console.error("Firebase or user not ready for listener.");
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/balance`);

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const balance = data.amount || 0;
                    balanceDisplay.textContent = balance.toFixed(2);
                    userBalanceSpan.textContent = `${balance.toFixed(2)} دينار`;
                } else {
                    // Create the document if it doesn't exist
                    setDoc(userDocRef, { amount: 0, lastUpdated: new Date() }).catch(e => console.error("Error creating document:", e));
                }
            }, (error) => {
                console.error("Error listening to balance:", error);
            });
        }

        // Updates the user's balance in Firestore
        async function updateBalance(amount) {
            if (!userId || !db) {
                showMessage('خطأ: المستخدم غير مسجل الدخول.');
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/balance`);

            try {
                // Get the current balance
                const docSnap = await getDoc(userDocRef);
                let currentBalance = 0;
                if (docSnap.exists()) {
                    currentBalance = docSnap.data().amount || 0;
                }

                // Calculate the new balance and update the document
                const newBalance = currentBalance + amount;
                await setDoc(userDocRef, { amount: newBalance, lastUpdated: new Date() });

                showMessage(`تهانينا! لقد ربحت ${amount.toFixed(2)} دينار. رصيدك الجديد هو ${newBalance.toFixed(2)} دينار.`);
            } catch (e) {
                console.error("Error updating balance:", e);
                showMessage('حدث خطأ أثناء تحديث رصيدك. يرجى المحاولة مرة أخرى.');
            }
        }

        // --- UI Rendering and Event Listeners ---

        // Renders the ad cards on the page
        function renderAds() {
            adsContainer.innerHTML = '';
            ads.forEach(ad => {
                const adCard = document.createElement('div');
                adCard.className = "ad-card bg-white rounded-xl overflow-hidden";
                adCard.innerHTML = `
                    <img src="${ad.imageUrl}" alt="${ad.title}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${ad.title}</h3>
                        <p class="text-gray-600 text-sm mb-4">${ad.description}</p>
                        <button class="watch-ad-btn bg-green-500 text-white px-4 py-2 rounded-full font-semibold w-full hover:bg-green-600 transition duration-300" data-reward="${ad.reward}">
                            شاهد واكسب ${ad.reward.toFixed(2)} دينار
                        </button>
                    </div>
                `;
                adsContainer.appendChild(adCard);
            });

            // Attach event listeners to the new buttons
            document.querySelectorAll('.watch-ad-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    if (!userId) {
                        showMessage('يجب تسجيل الدخول أولاً للمتابعة.');
                        return;
                    }

                    const reward = parseFloat(event.target.dataset.reward);
                    await updateBalance(reward);
                });
            });
        }

        // Sidebar show/hide logic
        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('open');
        });

        closeBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // Auth button event listeners
        emailSignInBtn.addEventListener('click', () => {
            showAuthModal('signIn');
        });

        emailSignUpBtn.addEventListener('click', () => {
            showAuthModal('signUp');
        });
        
        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showMessage('تم تسجيل الدخول بنجاح باستخدام غوغل.');
            } catch (error) {
                console.error("Google Sign-in error:", error);
                let message = 'حدث خطأ في المصادقة عبر غوغل.';
                if (error.code === 'auth/popup-closed-by-user') {
                    message = 'تم إغلاق نافذة المصادقة. يرجى المحاولة مرة أخرى.';
                } else if (error.code === 'auth/cancelled-by-user') {
                    message = 'تم إلغاء عملية المصادقة.';
                }
                showMessage(message);
            }
        });

        // Wallet button logic (simulated withdrawal)
        walletBtn.addEventListener('click', async () => {
            if (!userId) {
                showMessage('يجب تسجيل الدخول أولاً للوصول إلى المحفظة.');
                return;
            }

            const currentBalance = parseFloat(balanceDisplay.textContent);
            if (currentBalance >= 100) {
                // This is a simplified, simulated withdrawal process.
                // In a real application, this would involve external payment APIs.
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/balance`);
                await setDoc(userDocRef, { amount: currentBalance - 100, lastUpdated: new Date() });
                showMessage(`تمت محاكاة سحب 100 دينار بنجاح. رصيدك المتبقي هو ${ (currentBalance - 100).toFixed(2) } دينار.`);
            } else {
                showMessage(`رصيدك الحالي هو ${currentBalance.toFixed(2)} دينار. يجب أن يبلغ رصيدك 100 دينار على الأقل لإجراء عملية السحب.`);
            }
        });

        // Sign out logic
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('تم تسجيل خروجك بنجاح.');
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage('فشل تسجيل الخروج.');
            }
        });

        // --- Initial app load ---
        window.onload = () => {
            initializeFirebase();
            renderAds();
        };
    </script>
</body>
</html>
