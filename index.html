<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ‚Ø¹ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„ÙƒØ³Ø¨ Ø§Ù„Ø¯Ù†Ø§Ù†ÙŠØ±</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .ad-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .ad-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        #sidebar {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); }
            to { transform: translateY(0) scale(1); }
        }
        .balance-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-google {
            background: #db4437;
            transition: all 0.3s ease;
        }
        .btn-google:hover {
            background: #c23321;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <header class="glass-effect p-4 sticky top-0 z-40">
        <nav class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-white drop-shadow-lg">ğŸ’° Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="flex items-center space-x-2 space-x-reverse glass-effect px-4 py-2 rounded-full">
                    <span id="userBalance" class="text-xl font-semibold text-white">0.00 Ø¯ÙŠÙ†Ø§Ø±</span>
                    <i class="fas fa-coins text-yellow-400"></i>
                </div>
                <button id="menuBtn" class="glass-effect text-white px-4 py-2 rounded-full font-semibold hover:bg-white hover:bg-opacity-20 transition duration-300">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </nav>
    </header>

    <!-- Side Menu -->
    <div id="sidebar" class="fixed inset-y-0 right-0 w-80 shadow-xl z-50 p-6 flex flex-col justify-start items-center space-y-4">
        <button id="closeBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 transition duration-300">
            <i class="fas fa-times text-2xl"></i>
        </button>
        <div class="w-full text-center py-6 border-b border-gray-200">
            <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-3xl text-white"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800">Ø­Ø³Ø§Ø¨ÙŠ</h3>
            <p id="authStatus" class="text-sm text-gray-500 mt-1">ØºÙŠØ± Ù…ØªØµÙ„</p>
        </div>
        
        <!-- Auth buttons - will be shown/hidden based on login status -->
        <div id="authButtons" class="w-full space-y-4">
            <!-- Guest sign-in button -->
            <button id="signInAnonymouslyBtn" class="w-full btn-primary text-white px-6 py-3 rounded-full font-semibold transition duration-300 flex items-center justify-center">
                <i class="fas fa-user-circle ml-2"></i> 
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</span>
                <div id="anonLoader" class="loading-spinner ml-2 hidden"></div>
            </button>
            
            <button id="emailSignInBtn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                <i class="fas fa-envelope ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯
            </button>
            
            <button id="emailSignUpBtn" class="w-full bg-green-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-green-700 transition duration-300 flex items-center justify-center">
                <i class="fas fa-user-plus ml-2"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯
            </button>
            
            <!-- Google Sign-in Button -->
            <button id="googleSignInBtn" class="w-full btn-google text-white px-6 py-3 rounded-full font-semibold transition duration-300 flex items-center justify-center space-x-2 space-x-reverse">
                <i class="fab fa-google ml-2"></i> 
                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ØºÙˆØºÙ„</span>
                <div id="googleLoader" class="loading-spinner ml-2 hidden"></div>
            </button>
        </div>
        
        <!-- Logged-in user buttons - will be hidden initially -->
        <div id="loggedInButtons" class="w-full space-y-4 hidden">
            <button id="walletBtn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                <i class="fas fa-wallet ml-2"></i> Ù…Ø­ÙØ¸ØªÙŠ
            </button>
            
            <button id="signOutBtn" class="w-full bg-red-500 text-white px-6 py-3 rounded-full font-semibold hover:bg-red-600 transition duration-300 flex items-center justify-center">
                <i class="fas fa-sign-out-alt ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </div>
    </div>

    <main class="container mx-auto my-8 p-4 flex-grow">
        <div class="balance-card text-white p-8 rounded-2xl shadow-2xl mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold mb-2">ğŸ’ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                    <p class="text-4xl font-extrabold"><span id="balanceDisplay">0.00</span> Ø¯ÙŠÙ†Ø§Ø±</p>
                </div>
                <div class="text-6xl opacity-20">
                    <i class="fas fa-coins"></i>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-white drop-shadow-lg">ğŸ¯ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§ÙƒØ³Ø¨</h2>
            <div id="adCounter" class="glass-effect px-4 py-2 rounded-full text-white font-semibold">
                <i class="fas fa-eye ml-2"></i>
                <span id="watchedCount">0</span> / <span id="totalAds">0</span> Ù…Ø´Ø§Ù‡Ø¯Ø©
            </div>
        </div>
        
        <div id="adsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Ad cards will be inserted here by JavaScript -->
        </div>
    </main>

    <!-- Overlay for sidebar -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-30" onclick="closeSidebar()"></div>

    <!-- Modal for messages -->
    <div id="modal" class="modal-container">
        <div class="modal-content p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4">
            <div id="modalIcon" class="text-6xl mb-4">ğŸ‰</div>
            <p id="modalMessage" class="text-lg font-semibold mb-6 text-gray-800"></p>
            <button id="modalCloseButton" class="btn-primary text-white px-6 py-3 rounded-full font-semibold">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <!-- Modal for Email/Password forms -->
    <div id="authModal" class="modal-container">
        <div class="modal-content p-8 rounded-2xl shadow-2xl text-center w-96 mx-4">
            <h3 id="authModalTitle" class="text-2xl font-bold mb-6 text-gray-800"></h3>
            <div id="authError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
            <input type="email" id="authEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="w-full p-4 mb-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right">
            <input type="password" id="authPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full p-4 mb-6 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right">
            <button id="authSubmitBtn" class="w-full btn-primary text-white px-6 py-3 rounded-full font-semibold mb-4 flex items-center justify-center">
                <span>ØªØ£ÙƒÙŠØ¯</span>
                <div id="authLoader" class="loading-spinner ml-2 hidden"></div>
            </button>
            <button id="authModalCloseBtn" class="w-full text-gray-600 hover:text-gray-800 transition duration-300">
                Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Enable debug logging for Firebase Firestore
        setLogLevel('debug');

        // Global variables with fallbacks for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-ads-app';
        let firebaseConfig = {};
        
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.log("Using demo Firebase config");
        }
        
        // Demo configuration fallback to a working setup for public domains
        if (!firebaseConfig.apiKey) {
            firebaseConfig = {
                apiKey: "AIzaSyBvOKTyDlMuFMhFjoMUxe1HI_DECb-J6-I",
                authDomain: "ads-earnings-site.firebaseapp.com",
                projectId: "ads-earnings-site",
                storageBucket: "ads-earnings-site.appspot.com",
                messagingSenderId: "640635892482",
                appId: "1:640635892482:web:abc123def456ghi789"
            };
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Configure Google Auth Provider
        const googleProvider = new GoogleAuthProvider();
        googleProvider.setCustomParameters({
            prompt: 'select_account'
        });

        let watchedAds = new Set();
        

        // Get UI elements
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const closeBtn = document.getElementById('closeBtn');
        const overlay = document.getElementById('overlay');
        
        // Auth buttons
        const authButtons = document.getElementById('authButtons');
        const loggedInButtons = document.getElementById('loggedInButtons');
        const signInAnonymouslyBtn = document.getElementById('signInAnonymouslyBtn');
        const emailSignInBtn = document.getElementById('emailSignInBtn');
        const emailSignUpBtn = document.getElementById('emailSignUpBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const walletBtn = document.getElementById('walletBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const authStatus = document.getElementById('authStatus');

        const balanceDisplay = document.getElementById('balanceDisplay');
        const userBalanceSpan = document.getElementById('userBalance');
        const adsContainer = document.getElementById('adsContainer');
        const watchedCount = document.getElementById('watchedCount');
        const totalAds = document.getElementById('totalAds');

        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalIcon = document.getElementById('modalIcon');
        const modalCloseButton = document.getElementById('modalCloseButton');

        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const authModalCloseBtn = document.getElementById('authModalCloseBtn');
        const authError = document.getElementById('authError');

        // Loading spinners
        const anonLoader = document.getElementById('anonLoader');
        const googleLoader = document.getElementById('googleLoader');
        const authLoader = document.getElementById('authLoader');

        // Enhanced ads data with more variety
        const ads = [
            { 
                id: 1, 
                title: 'Ø³ÙŠØ§Ø±Ø© BMW Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 2024', 
                imageUrl: 'https://images.unsplash.com/photo-1555215695-3004980ad54e?w=400&h=250&fit=crop',
                reward: 0.50, 
                description: 'Ø§ÙƒØªØ´Ù Ø£Ø­Ø¯Ø« Ù…ÙˆØ¯ÙŠÙ„Ø§Øª BMW ÙˆØ§ÙƒØ³Ø¨ 0.50 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'Ø³ÙŠØ§Ø±Ø§Øª'
            },
            { 
                id: 2, 
                title: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹', 
                imageUrl: 'https://images.unsplash.com/photo-1512428813834-c702c7702b78?w=400&h=250&fit=crop',
                reward: 0.25, 
                description: 'Ø¬Ø±Ø¨ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø±Ø¹ ÙˆØ§ÙƒØ³Ø¨ 0.25 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'ØªØ·Ø¨ÙŠÙ‚Ø§Øª'
            },
            { 
                id: 3, 
                title: 'Ø£Ø­Ø°ÙŠØ© Ù†Ø§ÙŠÙƒÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©', 
                imageUrl: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&h=250&fit=crop',
                reward: 0.75, 
                description: 'Ø§ÙƒØªØ´Ù Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ø­Ø°ÙŠØ© Ù†Ø§ÙŠÙƒÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§ÙƒØ³Ø¨ 0.75 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'Ø±ÙŠØ§Ø¶Ø©'
            },
            { 
                id: 4, 
                title: 'Ù…Ø·Ø¹Ù… Ø§Ù„Ø¨Ø±Ø¬Ø± Ø§Ù„ÙØ§Ø®Ø±', 
                imageUrl: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=250&fit=crop',
                reward: 0.40, 
                description: 'ØªØ°ÙˆÙ‚ Ø£Ø´Ù‡Ù‰ Ø§Ù„Ø¨Ø±Ø¬Ø± ÙˆØ§ÙƒØ³Ø¨ 0.40 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'Ø·Ø¹Ø§Ù…'
            },
            { 
                id: 5, 
                title: 'Ø³Ø§Ø¹Ø© Ø°ÙƒÙŠØ© Ù…ØªØ·ÙˆØ±Ø©', 
                imageUrl: 'https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=250&fit=crop',
                reward: 0.60, 
                description: 'Ø§ÙƒØªØ´Ù Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§ÙƒØ³Ø¨ 0.60 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§'
            },
            { 
                id: 6, 
                title: 'Ø¯ÙˆØ±Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©', 
                imageUrl: 'https://images.unsplash.com/photo-1461749280684-dccba630e2f6?w=400&h=250&fit=crop',
                reward: 0.35, 
                description: 'ØªØ¹Ù„Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØ§ÙƒØ³Ø¨ 0.35 Ø¯ÙŠÙ†Ø§Ø±.',
                category: 'ØªØ¹Ù„ÙŠÙ…'
            }
        ];

        // --- Helper Functions ---
        
        function showMessage(message, icon = 'ğŸ‰', type = 'success') {
            modalMessage.textContent = message;
            modalIcon.textContent = icon;
            
            // Change modal styling based on type
            const modalContent = modal.querySelector('.modal-content');
            modalContent.className = 'modal-content p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4';
            
            if (type === 'error') {
                modalContent.classList.add('border-2', 'border-red-500');
            } else if (type === 'warning') {
                modalContent.classList.add('border-2', 'border-yellow-500');
            } else {
                modalContent.classList.add('border-2', 'border-green-500');
            }
            
            modal.style.display = 'flex';
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
            setTimeout(() => {
                authError.classList.add('hidden');
            }, 5000);
        }

        function hideAuthError() {
            authError.classList.add('hidden');
        }

        function showLoader(element, show = true) {
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.add('hidden');
        }

        function openSidebar() {
            sidebar.classList.add('open');
            overlay.classList.remove('hidden');
        }

        function showAuthModal(type) {
            authEmail.value = '';
            authPassword.value = '';
            hideAuthError();
            
            if (type === 'signIn') {
                authModalTitle.textContent = 'ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                authSubmitBtn.innerHTML = '<span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span><div id="authLoader" class="loading-spinner ml-2 hidden"></div>';
                authSubmitBtn.onclick = handleSignIn;
            } else {
                authModalTitle.textContent = 'ğŸ‘¤ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
                authSubmitBtn.innerHTML = '<span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span><div id="authLoader" class="loading-spinner ml-2 hidden"></div>';
                authSubmitBtn.onclick = handleSignUp;
            }
            authModal.style.display = 'flex';
        }

        async function handleSignIn() {
            const email = authEmail.value.trim();
            const password = authPassword.value;
            
            if (!email || !password) {
                showAuthError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
                return;
            }
            
            if (!isValidEmail(email)) {
                showAuthError('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.');
                return;
            }
            
            const authLoaderInModal = authSubmitBtn.querySelector('.loading-spinner');
            showLoader(authLoaderInModal, true);
            authSubmitBtn.disabled = true;
            hideAuthError();
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                authModal.style.display = 'none';
                showMessage('ØªÙ…Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ', 'âœ…');
                closeSidebar();
            } catch (error) {
                console.error("Sign-in Error:", error);
                handleAuthError(error);
            } finally {
                showLoader(authLoaderInModal, false);
                authSubmitBtn.disabled = false;
            }
        }

        async function handleSignUp() {
            const email = authEmail.value.trim();
            const password = authPassword.value;
            
            if (!email || !password) {
                showAuthError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
                return;
            }
            
            if (!isValidEmail(email)) {
                showAuthError('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
                return;
            }
            
            const authLoaderInModal = authSubmitBtn.querySelector('.loading-spinner');
            showLoader(authLoaderInModal, true);
            authSubmitBtn.disabled = true;
            hideAuthError();
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                authModal.style.display = 'none';
                showMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ', 'âœ…');
                closeSidebar();
            } catch (error) {
                console.error("Sign-up Error:", error);
                handleAuthError(error);
            } finally {
                showLoader(authLoaderInModal, false);
                authSubmitBtn.disabled = false;
            }
        }

        function handleAuthError(error) {
            let message = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©.';
            
            switch(error.code) {
                case 'auth/email-already-in-use':
                    message = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.';
                    break;
                case 'auth/invalid-credential':
                case 'auth/invalid-login-credentials':
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    message = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                    break;
                case 'auth/weak-password':
                    message = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹. ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
                    break;
                case 'auth/invalid-email':
                    message = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.';
                    break;
                case 'auth/network-request-failed':
                    message = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
                    break;
                case 'auth/too-many-requests':
                    message = 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
                    break;
                case 'auth/popup-closed-by-user':
                    message = 'ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                    break;
                case 'auth/cancelled-popup-request':
                    message = 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.';
                    break;
                case 'auth/unauthorized-domain':
                    message = 'Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Console.';
                    break;
                default:
                    message = `Ø®Ø·Ø£: ${error.message}`;
            }
            
            showAuthError(message);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                let displayName = 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„';
                if (user.displayName) {
                    displayName = user.displayName;
                } else if (user.email && !user.isAnonymous) {
                    displayName = user.email.split('@')[0];
                }
                
                authStatus.innerHTML = `<span class="text-green-600">Ù…ØªØµÙ„</span><br><small>${displayName}</small>`;
                
                // Show logged-in buttons, hide auth buttons
                authButtons.classList.add('hidden');
                loggedInButtons.classList.remove('hidden');
                
                setupRealtimeListener(user.uid);
            } else {
                authStatus.innerHTML = '<span class="text-red-500">ØºÙŠØ± Ù…ØªØµÙ„</span>';
                balanceDisplay.textContent = '0.00';
                userBalanceSpan.textContent = '0.00 Ø¯ÙŠÙ†Ø§Ø±';
                
                // Show auth buttons, hide logged-in buttons
                authButtons.classList.remove('hidden');
                loggedInButtons.classList.add('hidden');
                
                watchedAds.clear();
                updateAdCounter();
                renderAds();
            }
        });

        function setupRealtimeListener(uid) {
            if (!uid || !db) {
                console.error("Firebase or user not ready for listener.");
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/user_data/balance`);

            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const balance = data.amount || 0;
                    balanceDisplay.textContent = balance.toFixed(2);
                    userBalanceSpan.textContent = `${balance.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±`;
                } else {
                    setDoc(userDocRef, { 
                        amount: 0, 
                        lastUpdated: new Date(),
                        totalEarned: 0 
                    }).catch(e => console.error("Error creating document:", e));
                }
            }, (error) => {
                console.error("Error listening to balance:", error);
            });
        }

        async function updateBalance(amount) {
            if (!auth.currentUser || !db) {
                showMessage('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.', 'ğŸ”', 'warning');
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/user_data/balance`);

            try {
                const docSnap = await getDoc(userDocRef);
                let currentBalance = 0;
                if (docSnap.exists()) {
                    currentBalance = docSnap.data().amount || 0;
                }

                const newBalance = currentBalance + amount;
                await setDoc(userDocRef, { 
                    amount: newBalance, 
                    lastUpdated: new Date(),
                    totalEarned: (docSnap.exists() ? (docSnap.data().totalEarned || 0) : 0) + amount
                });

                showMessage(`ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø±Ø¨Ø­Øª ${amount.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±\nğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBalance.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±`, 'ğŸ’');
            } catch (e) {
                console.error("Error updating balance:", e);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'âŒ', 'error');
            }
        }

        // --- UI Rendering and Event Listeners ---

        function updateAdCounter() {
            watchedCount.textContent = watchedAds.size;
            totalAds.textContent = ads.length;
        }

        function renderAds() {
            adsContainer.innerHTML = '';
            updateAdCounter();
            
            ads.forEach((ad, index) => {
                const isWatched = watchedAds.has(ad.id);
                const adCard = document.createElement('div');
                adCard.className = `ad-card rounded-2xl overflow-hidden ${isWatched ? 'opacity-60' : ''}`;
                adCard.style.animationDelay = `${index * 0.1}s`;
                
                adCard.innerHTML = `
                    <div class="relative">
                        <img src="${ad.imageUrl}" alt="${ad.title}" class="w-full h-48 object-cover">
                        <div class="absolute top-4 right-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-md">
                            ${ad.reward.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø±
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${ad.title}</h3>
                        <p class="text-gray-600 text-sm mb-4">${ad.description}</p>
                        <button id="ad-${ad.id}" class="btn-primary w-full text-white px-6 py-3 rounded-full font-semibold ${isWatched ? 'cursor-not-allowed opacity-50' : ''}" ${isWatched ? 'disabled' : ''}>
                            Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                        </button>
                    </div>
                `;
                
                adsContainer.appendChild(adCard);
                
                const watchBtn = document.getElementById(`ad-${ad.id}`);
                watchBtn.addEventListener('click', () => {
                    if (!watchedAds.has(ad.id)) {
                        watchedAds.add(ad.id);
                        updateBalance(ad.reward);
                        updateAdCounter();
                        watchBtn.disabled = true;
                        watchBtn.classList.add('cursor-not-allowed', 'opacity-50');
                        adCard.classList.add('opacity-60');
                        showMessage(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${ad.reward.toFixed(2)} Ø¯ÙŠÙ†Ø§Ø± Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ.`, 'âœ…');
                    }
                });
            });
        }
        
        // Add event listener to menu button
        menuBtn.addEventListener('click', openSidebar);

        // Add event listeners for sidebar
        closeBtn.addEventListener('click', closeSidebar);
        overlay.addEventListener('click', closeSidebar);

        // Add event listeners for auth buttons
        signInAnonymouslyBtn.addEventListener('click', async () => {
            showLoader(anonLoader, true);
            try {
                await signInAnonymously(auth);
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'âœ…');
                closeSidebar();
            } catch (error) {
                console.error("Anonymous sign-in error:", error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'âŒ', 'error');
            } finally {
                showLoader(anonLoader, false);
            }
        });

        emailSignInBtn.addEventListener('click', () => showAuthModal('signIn'));
        emailSignUpBtn.addEventListener('click', () => showAuthModal('signUp'));

        googleSignInBtn.addEventListener('click', async () => {
            showLoader(googleLoader, true);
            try {
                await signInWithPopup(auth, googleProvider);
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± ØºÙˆØºÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'âœ…');
                closeSidebar();
            } catch (error) {
                console.error("Google sign-in error:", error);
                handleAuthError(error);
            } finally {
                showLoader(googleLoader, false);
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­. Ù†Ø±Ø§Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹!', 'ğŸ‘‹');
                closeSidebar();
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'âŒ', 'error');
            }
        });

        modalCloseButton.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        authModalCloseBtn.addEventListener('click', () => {
            authModal.style.display = 'none';
        });

        // Initialize and render
        renderAds();
        
        // This is a dummy function and should not be used in production
        // It's for demonstration purposes to show the wallet functionality
        walletBtn.addEventListener('click', () => {
            showMessage("Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¯Ø§Ø±Ø© Ø±ØµÙŠØ¯Ùƒ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„.", 'ğŸ’¼', 'info');
        });

        // Add event listener for the menu button
        document.addEventListener('DOMContentLoaded', () => {
            const menuButton = document.getElementById('menuBtn');
            const sidebarElement = document.getElementById('sidebar');
            const closeButton = document.getElementById('closeBtn');
            
            menuButton.addEventListener('click', () => {
                sidebarElement.classList.add('open');
            });
            
            closeButton.addEventListener('click', () => {
                sidebarElement.classList.remove('open');
            });
        });
        
    </script>
</body>
</html>
